<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Voice Gemini</title>
</head>
<body>
<h1>Voice Gemini Chat</h1>

<form id="textForm">
  <input type="text" id="user_input" placeholder="í…ìŠ¤íŠ¸ ì…ë ¥">
  <button type="submit">ì „ì†¡</button>
</form>

<button id="recordBtn">ğŸ¤ ë…¹ìŒ</button>

<h2>ëŒ€í™”</h2>
<ul id="chat">
  {% for s,t in chat_history %}
    <li><b>{{s}}:</b> {{t}}</li>
  {% endfor %}
</ul>

<audio id="ttsAudio" controls></audio>

<script>
const chatEl = document.getElementById("chat");
const ttsAudio = document.getElementById("ttsAudio");

// í…ìŠ¤íŠ¸ ì „ì†¡
document.getElementById("textForm").onsubmit = async e=>{
  e.preventDefault();
  let val=document.getElementById("user_input").value;
  let res=await fetch("/stt_file",{method:"POST", body:new FormData()});
}

// ë¸Œë¼ìš°ì € ë…¹ìŒ â†’ ì„œë²„ë¡œ íŒŒì¼ ì „ì†¡
document.getElementById("recordBtn").onclick = async ()=>{
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  const media = new MediaRecorder(stream);
  let chunks=[];
  media.ondataavailable = e=>chunks.push(e.data);
  media.onstop = async ()=>{
    const blob = new Blob(chunks,{type:'audio/wav'});
    const fd = new FormData();
    fd.append("file", blob, "voice.wav");
    const res = await fetch("/stt_file",{method:"POST", body:fd});
    const data = await res.json();
    chatEl.innerHTML += `<li><b>user:</b> ${data.user}</li>`;
    chatEl.innerHTML += `<li><b>bot:</b> ${data.bot}</li>`;
    ttsAudio.src="/tts_audio?ts="+Date.now();
  };
  media.start();
  setTimeout(()=>media.stop(),5000); // 5ì´ˆ ë…¹ìŒ
};
</script>
</body>
</html>
